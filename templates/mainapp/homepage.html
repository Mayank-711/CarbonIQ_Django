{% extends 'mainapp/base.html' %}
{% load static %}
{% block title %}Home{% endblock %}

{% block extra_head %}
    <link rel="stylesheet" href="{% static 'css/homepage.css' %}">
{% endblock %}

{% block content %}
    <div class="container">
        <div class="row">
            <div class="col-md-12">
                <div class="form-container">
                    <h2>Log Your Trip</h2>
                    <form id="trip-form" action="{% url "log_trip" %}" method="post">
                        {% csrf_token %}
                        <label for="source">Source</label>
                        <input type="text" id="source-input" name="source" placeholder="Enter source location" required />
                        <ul id="source-results" class="autocomplete-results"></ul>
                        <input type="hidden" id="source-lat" name="source_lat">
                        <input type="hidden" id="source-lng" name="source_lng">

                        <label for="destination">Destination</label>
                        <input type="text" id="destination-input" name="destination" placeholder="Enter destination location" required />
                        <ul id="destination-results" class="autocomplete-results"></ul>
                        <input type="hidden" id="dest-lat" name="dest_lat">
                        <input type="hidden" id="dest-lng" name="dest_lng">

                        <label for="mode-of-transport">Mode of Transport</label>
                        <select id="mode-of-transport" name="mode_of_transport" required>
                            <option value="bus">Bus</option>
                            <option value="train">Local Train</option>
                            <option value="actrain">Metro</option>
                            <option value="car">Car</option>
                            <option value="bike">Bike</option>
                            <option value="walk">Walk</option>
                            <option value="bicycle">Bicycle</option>
                            <option value="rickshaw">Rickshaw</option>
                            <option value="scooter">Scooter</option>
                        </select>
                        <label for="electric-vehicle">Electric Vehicle?</label>
                        <select id="electric-vehicle" name="electric_vehicle">
                            <option value="No">No</option>
                             <option value="Yes">Yes</option>
                        </select>
                        <label for="date">Date</label>
                        <input type="date" id="date" name="date" required />
                        <label for="time-taken">Time Taken (minutes)</label>
                        <input type="number" id="time-taken" name="time_taken" step="1" required />

                             <!-- Hidden fields to capture API values -->
                    <input type="hidden" id="calculated-distance" name="calculated_distance">
                    <input type="hidden" id="calculated-duration" name="calculated_duration">
                    
                        <button type="submit">Submit Trip</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block extra_scripts %}
<script>
   document.addEventListener('DOMContentLoaded', function () {
    const OLAMAPS_API = "upIsbo0X7RjH2SfHjy2eYpm8TWdynT6vFDCpA85y";
    const sourceInput = document.getElementById('source-input');
    const destInput = document.getElementById('destination-input');
    const sourceResults = document.getElementById('source-results');
    const destResults = document.getElementById('destination-results');

    const fetchSuggestions = async (input, resultsList, setCoords) => {
        const query = input.value.trim();
        if (query.length > 2) {
            try {
                const response = await fetch(`https://api.olamaps.io/places/v1/autocomplete?input=${encodeURIComponent(query)}&api_key=${OLAMAPS_API}`);
                const data = await response.json();
                const predictions = data.predictions || [];
                resultsList.innerHTML = '';
                resultsList.style.display = predictions.length ? 'block' : 'none';

                predictions.forEach(prediction => {
                    if (prediction.description && prediction.geometry) {
                        const listItem = document.createElement('li');
                        listItem.textContent = prediction.description;
                        listItem.addEventListener('click', () => {
                            input.value = prediction.description;
                            setCoords(prediction.geometry.location.lat, prediction.geometry.location.lng);
                            resultsList.innerHTML = '';
                            resultsList.style.display = 'none';
                        });
                        resultsList.appendChild(listItem);
                    }
                });
            } catch (error) {
                alert('Error fetching predictions. Please check your connection.');
            }
        }
    };

    sourceInput.addEventListener('input', () => fetchSuggestions(sourceInput, sourceResults, (lat, lng) => {
        document.getElementById('source-lat').value = lat;
        document.getElementById('source-lng').value = lng;
    }));

    destInput.addEventListener('input', () => fetchSuggestions(destInput, destResults, (lat, lng) => {
        document.getElementById('dest-lat').value = lat;
        document.getElementById('dest-lng').value = lng;
    }));

    document.getElementById('trip-form').addEventListener('submit', async (e) => {
        e.preventDefault();

        const sourceLat = document.getElementById('source-lat').value;
        const sourceLng = document.getElementById('source-lng').value;
        const destLat = document.getElementById('dest-lat').value;
        const destLng = document.getElementById('dest-lng').value;

        if (!sourceLat || !sourceLng || !destLat || !destLng) {
            alert('Please select valid source and destination coordinates.');
            return;
        }

        try {
            const apiUrl = `https://api.olamaps.io/routing/v1/directions?origin=${sourceLat},${sourceLng}&destination=${destLat},${destLng}&mode=driving&alternatives=false&steps=true&overview=full&language=en&traffic_metadata=true&api_key=${OLAMAPS_API}`;

            const routeResponse = await fetch(apiUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                },
                body: ''
            });

            if (!routeResponse.ok) {
                const errorText = await routeResponse.text();
                alert(`Routing API error: ${errorText}`);
                return;
            }

            const routeData = await routeResponse.json();

            if (routeData.routes && routeData.routes.length > 0) {
                const legs = routeData.routes[0].legs;
                    const totalDistance = legs.reduce((sum, leg) => sum + leg.distance, 0) / 1000;
                    const totalDuration = legs.reduce((sum, leg) => sum + leg.duration, 0) / 60;

                    // Set calculated values before form submission
                    document.getElementById('calculated-distance').value = totalDistance.toFixed(2);
                    document.getElementById('calculated-duration').value = totalDuration.toFixed(2);

                    document.getElementById('trip-form').submit(); // Trigger the form submission
            } else {
                alert('Unable to calculate route. Please try again.');
            }
        } catch (error) {
            alert('Error fetching route details. Please try again.');
        }
    });
});

    

</script>
{% endblock %}
